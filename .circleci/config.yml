version: 2.1

jobs:
  build-and-test:
    machine:
      image: ubuntu-2204:current
    steps:
      - checkout

      - run:
          name: Setup Credentials and Environment
          command: |
            if [ -n "$NPMRC_CONTENT" ]; then
              echo "$NPMRC_CONTENT" > .npmrc
            fi

            cp .env.test .env || true
            cp .env.test backend/notifications/.env.test || true

      - run:
          name: Pre-clean Docker
          command: |
            docker compose -f backend/docker-compose.test.yml down -v --remove-orphans

      - run:
          name: Run Full Stack E2E Tests
          command: |
            node ./up_test.js

      - run:
          name: Post-test Cleanup
          command: docker compose -f backend/docker-compose.test.yml down -v
          when: always

  plan-release:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Orchestrate Release
          command: |
            SHORT_SHA=$(echo $CIRCLE_SHA1 | cut -c1-7)

            circleci run release plan \
              --environment-name="production" \
              --component-name="notifications-fullstack" \
              --target-version="${SHORT_SHA}"
      - run:
          name: Mark Release Success
          command: circleci run release update --status=SUCCESS
          when: on_success
      - run:
          name: Mark Release Failed
          command: circleci run release update --status=FAILED
          when: on_fail

workflows:
  main:
    jobs:
      - build-and-test
      - plan-release:
          requires:
            - build-and-test
