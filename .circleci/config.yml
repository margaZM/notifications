version: 2.1

orbs:
  coveralls: coveralls/coveralls@2.2.5

jobs:
  build-and-test:
    machine:
      image: ubuntu-2204:current
    steps:
      - checkout

      - run:
          name: Setup Credentials and Environment
          command: |
            # Create .npmrc with GitHub token
            if [ -n "$GITHUB_TOKEN" ]; then
              echo "@margazm:registry=https://npm.pkg.github.com" > .npmrc
              echo "//npm.pkg.github.com/:_authToken=$GITHUB_TOKEN" >> .npmrc
              echo "node-linker=hoisted" >> .npmrc
              cp .npmrc backend/.npmrc
            fi

            echo 'NODE_ENV="test"' > .env
            echo "DATABASE_URL=\"$DATABASE_URL\"" >> .env
            echo "JWT_SECRET=\"$JWT_SECRET\"" >> .env
            echo "JWT_EXPIRES_IN=\"$JWT_EXPIRES_IN\"" >> .env
            echo "TWILIO_ACCOUNT_SID=\"$TWILIO_ACCOUNT_SID\"" >> .env
            echo "TWILIO_AUTH_TOKEN=\"$TWILIO_AUTH_TOKEN\"" >> .env
            echo "TWILIO_SERVICE_ID=\"$TWILIO_SERVICE_ID\"" >> .env
            echo "TWILIO_PHONE_NUMBER=\"$TWILIO_PHONE_NUMBER\"" >> .env
            echo "SENDGRID_API_KEY=\"$SENDGRID_API_KEY\"" >> .env
            echo "SENDGRID_SYSTEM_EMAIL_ADDRESS=\"$SENDGRID_SYSTEM_EMAIL_ADDRESS\"" >> .env
            echo "SENDGRID_BASE_TEMPLATE_ID=\"$SENDGRID_BASE_TEMPLATE_ID\"" >> .env

            cp .env backend/.env.test
            cp .env .env.test

      - run:
          name: Pre-clean Docker
          command: |
            docker compose -f backend/docker-compose.test.yml down -v --remove-orphans

      - run:
          name: Run Full Stack E2E Tests
          command: |
            node ./up.test.js

      - coveralls/upload:
          coverage_file: ./backend/apps/auth/coverage-e2e/lcov.info # Nombre correcto del par√°metro
          flag_name: auth-service
          parallel: true

      - coveralls/upload:
          coverage_file: ./backend/apps/contacts/coverage-e2e/lcov.info
          flag_name: contacts-service
          parallel: true

      - coveralls/upload:
          coverage_file: ./backend/apps/notifications/coverage-e2e/lcov.info
          flag_name: notifications-service
          parallel: true

      - run:
          name: Post-test Cleanup
          command: |
            docker compose -f backend/docker-compose.test.yml down -v
          when: always

      - run:
          name: Finalize Coveralls
          command: |
            curl -k https://coveralls.io/webhook?repo_token=$COVERALLS_REPO_TOKEN -d "payload[build_num]=$CIRCLE_BUILD_NUM&payload[status]=done"

      - run:
          name: Post-test Cleanup
          command: |
            docker compose -f backend/docker-compose.test.yml down -v
          when: always

  plan-release:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Orchestrate Release
          command: |
            SHORT_SHA=$(echo $CIRCLE_SHA1 | cut -c1-7)
            circleci run release plan \
              --environment-name="production" \
              --component-name="notifications-fullstack" \
              --target-version="${SHORT_SHA}"
      - run:
          name: Mark Release Success
          command: circleci run release update --status=SUCCESS
          when: on_success
      - run:
          name: Mark Release Failed
          command: circleci run release update --status=FAILED
          when: on_fail

workflows:
  main:
    jobs:
      - build-and-test
      - plan-release:
          requires:
            - build-and-test
