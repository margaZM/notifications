version: 2.1

jobs:
  build-and-test:
    machine:
      image: ubuntu-2204:current
    steps:
      - checkout

      - run:
          name: Setup Credentials and Environment
          command: |-
            if [ -n "$NPMRC_CONTENT" ]; then
              echo "$NPMRC_CONTENT" > .npmrc
            fi
            cat > .env << 'EOF'
            NODE_ENV="test"
            DATABASE_URL="$DATABASE_URL"
            JWT_SECRET="$JWT_SECRET"
            JWT_EXPIRES_IN="$JWT_EXPIRES_IN"
            TWILIO_ACCOUNT_SID="$TWILIO_ACCOUNT_SID"
            TWILIO_AUTH_TOKEN="$TWILIO_AUTH_TOKEN"
            TWILIO_SERVICE_ID="$TWILIO_SERVICE_ID"
            TWILIO_PHONE_NUMBER="$TWILIO_PHONE_NUMBER"
            SENDGRID_API_KEY="$SENDGRID_API_KEY"
            SENDGRID_SYSTEM_EMAIL_ADDRESS="$SENDGRID_SYSTEM_EMAIL_ADDRESS"
            SENDGRID_BASE_TEMPLATE_ID="$SENDGRID_BASE_TEMPLATE_ID"
            EOF
            cp .env backend/.env.test
            cp .env .env.test

      - run:
          name: Pre-clean Docker
          command: |
            docker compose -f backend/docker-compose.test.yml down -v --remove-orphans

      - run:
          name: Run Full Stack E2E Tests
          command: |
            node ./up_test.js

      - run:
          name: Post-test Cleanup
          command: |
            docker compose -f backend/docker-compose.test.yml down -v
          when: always

  plan-release:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Orchestrate Release
          command: |
            SHORT_SHA=$(echo $CIRCLE_SHA1 | cut -c1-7)
            circleci run release plan \
              --environment-name="production" \
              --component-name="notifications-fullstack" \
              --target-version="\${SHORT_SHA}"
      - run:
          name: Mark Release Success
          command: circleci run release update --status=SUCCESS
          when: on_success
      - run:
          name: Mark Release Failed
          command: circleci run release update --status=FAILED
          when: on_fail

workflows:
  main:
    jobs:
      - build-and-test
      - plan-release:
          requires:
            - build-and-test
